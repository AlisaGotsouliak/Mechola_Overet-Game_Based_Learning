@page "/EditGame/RouteParams/{GameCode:int}/{GameName}/{GameTime:int}"
@using template.Shared.Games;
@using template.Shared.Models.Games;
@using template.Client.Components;
@inject HttpClient Http;

<div class="page_bg" style="display:flex; justify-content:center; flex-direction:column">
    <h3>עריכת משחק</h3>
    <div id="allAccordions">
        <div id="settingsAndQList">
            <div class="accordion" id="accordionExample">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingOne">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                            <span class="tabName">
                                הגדרות כלליות
                            </span>
                        </button>
                    </h2>
                    @* ***************************** Game Settings for new game ***************************** *@
                    <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne">
                        <div class="accordion-body">

                            @if (GameName == "")
                            {
                                <EditForm Model="gameToAdd" OnValidSubmit="CreateGame">
                                    <DataAnnotationsValidator />
                                    <div>שם משחק:</div>
                                    <div id="gameNameToolTip">?</div>
                                    <CustomInputText @bind-Value="gameToAdd.Game" maxLength="20" minLength="3" />
                                    <ValidationMessage For="@(() => gameToAdd.Game)" />
                                    <div>זמן לשאלה:</div>
                                    <div id="qTimeToolTip">?</div>
                                    <div>
                                        <select id="timeOptions" @bind="gameToAdd.Time">
                                            <option value="50">50 שניות</option>
                                            <option value="60">60 שניות</option>
                                            <option value="90">90 שניות</option>
                                            <option value="0">ללא הגבלה</option>
                                        </select>
                                    </div>
                                    <br />
                                    <input type="submit" value="שמירת הגדרות" class="Allbuttons" />

                                </EditForm>
                            }
                            else @* ***************************** Edit Game Settings ***************************** *@
                            {
                                <EditForm Model="gameToAdd" OnValidSubmit="UpdateGame">
                                    <DataAnnotationsValidator />
                                    <div>שם משחק:</div>
                                    <div id="gameNameToolTip">?</div>
                                    <CustomInputText @bind-Value="gameToAdd.Game" maxLength="20" minLength="3" />
                                    <ValidationMessage For="@(() => gameToAdd.Game)" />
                                    <div>זמן לשאלה:</div>
                                    <div id="qTimeToolTip">?</div>
                                    <div>
                                        <select id="timeOptions" @bind="gameToAdd.Time">
                                            <option value="50">50 שניות</option>
                                            <option value="60">60 שניות</option>
                                            <option value="90">90 שניות</option>
                                            <option value="0">ללא הגבלה</option>
                                        </select>
                                    </div>

                                    @if (gameToAdd.Game.Length < 3)
                                    {
                                        <input type="submit" value="שמירת הגדרות" class="Allbuttons" disabled />
                                    }
                                    else
                                    {
                                        <input type="submit" value="שמירת הגדרות" class="Allbuttons" />
                                    }
                                </EditForm>
                            }

                        </div>
                    </div>
                </div>
            </div>
            @* ***************************** Question List ***************************** *@
            @if (GameName != "" || CanAddQuestions)
            {
                <div class="accordion" id="accordionExample">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingTwo">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                שאלות המשחק
                            </button>
                        </h2>
                        <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo">
                            <div class="accordion-body">
                                @if (gameToAdd.Game != " " && gameToAdd.Time != null)
                                {
                                    if (full_gameInfo.question_List != null)
                                    {
                                        @foreach (QuestionDB question in full_gameInfo.question_List)
                                        {
                                            <div @onclick="(() =>ShowQuestion(question))" class="questionInList">
                                                <p>@question.QuestionText</p>
                                                <div @onclick="() => RemoveInput(question)" class="deleteIcon"></div> @* value="מחק" *@
                                            </div>
                                        }
                                    }
                                    <input type="button" value="+" @onclick="AddInput" class="Allbuttons addButton">
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
            else
            {
                <div class="accordion" id="accordionExample">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingTwo">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo" disabled style="opacity:70%">
                                שאלות המשחק
                            </button>
                        </h2>
                    </div>
                </div>
            }
        </div>

        @* ***************************** Create new question ***************************** *@

        @if (isShown == "true")
        {
            <div class="accordion" id="accordionExample">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingThree">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse">
                            יצירת שאלה
                        </button>
                    </h2>
                    <div id="collapseThree" class="accordion-collapse show" aria-labelledby="headingThree">
                        <div class="accordion-body">
                            <p>שאלה</p>
                            <EditForm Model="toShow" OnValidSubmit="AddQuestion">
                                <DataAnnotationsValidator />
                                <CustomInputText @bind-Value="toShow.QuestionText" maxLength="100" minLength="7" />
                                <ValidationMessage For="@(() => toShow.QuestionText)" />
                                <input type="text" style="border: solid black; padding: 5px; margin-top: 20px; margin-bottom: 10px; border-radius: 5px;" placeholder="Image" @bind=toShow.QuestionImage />
                                @if (toShow.Answers != null)
                                {
                                    bool oneAnsCorrect = false;
                                    foreach (AnswerDB ans in toShow.Answers)
                                    {
                                        <input type="radio" name="answersGroup" checked="@ans.IsCorrect" @onchange="() => SelectAnswer(ans)" />
                                        @if (ans.IsCorrect)
                                            oneAnsCorrect = true;
                                        @if (ans.AnswerText != "")
                                        {
                                            <input type="text" @bind=ans.AnswerText />
                                        }
                                        else
                                        {
                                            <input type="text" @bind=ans.AnswerImage />
                                        }
                                    }
                                    @if (toShow.Answers.Count >= 2 && oneAnsCorrect)
                                    {
                                        <input type="submit" value="Save" class="Allbuttons">
                                    }
                                    else
                                    {
                                        <input type="submit" value="Save" class="Allbuttons" style="opacity:70%" disabled>
                                    }
                                    @if (toShow.Answers.Count < 6)
                                    {
                                        <input type="button" value="+" @onclick="AddAns" class="Allbuttons addButton">
                                    }
                                }


                            </EditForm>
                        </div>
                    </div>
                </div>
            </div>
        }
        @* ***************************** Edit question ***************************** *@
        else if (isShown == "Edit")
        {
            <div class="accordion" id="accordionExample">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingThree">
                        <button class="accordion-button" data-bs-toggle="collapse">
                            עריכת שאלה
                        </button>
                    </h2>
                    <div id="collapseThree" class="accordion-collapse show" aria-labelledby="headingThree">
                        <div class="accordion-body">
                            <p>שאלה</p>
                            <div>
                                @if (toShow != null)
                                {
                                    <EditForm Model="toShow" OnValidSubmit="EditQuestion">
                                        <DataAnnotationsValidator />
                                        <div id="questionArea">
                                            <CustomInputText @bind-Value="toShow.QuestionText" maxLength="100" minLength="7" id="questionInput" />
                                            <ValidationMessage For="@(() => toShow.QuestionText)" />
                                            <input type="button" id="insertQuestionImage" />
                                        </div>
                                        <p>מסיחים</p>
                                        @if (toShow.Answers != null)
                                        {
                                            <div id="answersArea">
                                                @foreach (AnswerDB ans in toShow.Answers)
                                                {
                                                    <div>
                                                        <input type="radio" name="answersGroup" checked="@ans.IsCorrect" @onchange="() => SelectAnswer(ans)" />

                                                        @if (ans.AnswerText != "")
                                                        {
                                                            <input type="text" @bind=ans.AnswerText class="questionAnswersInputs" />
                                                        }
                                                        else
                                                        {
                                                            <input type="text" @bind=ans.AnswerImage />
                                                        }
                                                    </div>
                                                }
                                            </div>
                                            @if (toShow.Answers.Count < 6)
                                            {
                                                <input type="button" value="+" @onclick="AddAns" class="Allbuttons addButton">
                                            }
                                            @if (toShow.Answers.Count >= 2)
                                            {
                                                <input type="submit" value="שמירת שאלה" class="Allbuttons">
                                            }
                                            else
                                            {
                                                <input type="submit" value="שמירת שאלה" class="Allbuttons" style="opacity:70%" disabled>
                                            }
                                        }
                                    </EditForm>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>

    <p>@msg</p>
</div>
@code {
    bool CanAddQuestions = false;
    GameToAdd gameToAdd = new GameToAdd();
    SettingsUpdate settingToSend = new SettingsUpdate();
    QuestionDB toShow = new QuestionDB();
    string isShown = "false";
    string msg = "";
    FullGame full_gameInfo = new FullGame();
    [Parameter]
    public int GameCode { get; set; }
    [Parameter]
    public string GameName { get; set; }
    [Parameter]
    public int GameTime { get; set; }

    protected override async Task OnInitializedAsync()
    {
        if (GameName == " ")
            GameName = "";
        gameToAdd.Time = GameTime;
        gameToAdd.Game = GameName;
        settingToSend.GameCode = GameCode;

        var full_game_res = await Http.GetAsync("api/Games/GetFullGame/" + GameCode);
        if (full_game_res.IsSuccessStatusCode)
        {
            full_gameInfo = full_game_res.Content.ReadFromJsonAsync<FullGame>().Result;
        }
        else if (GameName != "")
            msg = full_game_res.Content.ReadAsStringAsync().Result;
    }

    private void SelectAnswer(AnswerDB selectedAnswer)
    {
        foreach (var answer in toShow.Answers)
        {
            answer.IsCorrect = answer == selectedAnswer; //goes through all answers and sets the IsCorrect to true only for the selected answer and false for all others.
        }
    }

    async Task CreateGame()
    {
        //שליחת המשחק החדש לקונטרולר
        var newGameRes = await Http.PostAsJsonAsync("api/Games/addGame", gameToAdd);
        if (newGameRes.IsSuccessStatusCode == true)
        {
            msg = "הוספת משחק בוצע";
            //החזרת המשחק והוספתו לרשימת המשחקים כדי שיתווסף לטבלה
            GameToCard newGame = newGameRes.Content.ReadFromJsonAsync<GameToCard>().Result;
            //gameToAdd.Time = newGame.Time;
            full_gameInfo.Game = newGame.Game;
            full_gameInfo.Time = newGame.Time;
            CanAddQuestions = true;
        }
        else
        {
            CanAddQuestions = false;
            string error = newGameRes.Content.ReadAsStringAsync().Result;
            ShowError(error);
        }
    }

    async Task UpdateGame()
    {
        settingToSend.Time = gameToAdd.Time;
        settingToSend.Game = gameToAdd.Game;
        var newGameRes = await Http.PostAsJsonAsync("api/Games/Update", settingToSend);
        string error = newGameRes.Content.ReadAsStringAsync().Result;
        if (error != "Updated")
            CanAddQuestions = false;
        else
            CanAddQuestions = true;
        ShowError(error);
    }

    async Task AddQuestion()
    {
        if (toShow.QuestionImage == null)
            toShow.QuestionImage = "No Image";
        foreach (AnswerDB ans in toShow.Answers)
        {
            if (ans.AnswerImage == null)
                ans.AnswerImage = "No image";
        }
        var addQ = await Http.PostAsJsonAsync("api/Games/AddQuestion", toShow);
        if (addQ.IsSuccessStatusCode)
        {
            full_gameInfo.question_List = addQ.Content.ReadFromJsonAsync<List<QuestionDB>>().Result;
            toShow = new QuestionDB();
            toShow.QuestionText = "";
            toShow.GameID = GameCode;
        }
    }
    async Task EditQuestion()
    {
        if (toShow.QuestionImage == null)
            toShow.QuestionImage = "No Image";
        foreach (AnswerDB ans in toShow.Answers)
        {
            if (ans.AnswerImage == null)
                ans.AnswerImage = "No image";
        }
        var editQ = await Http.PostAsJsonAsync("api/Games/EditQuestion", toShow);
        if (editQ.IsSuccessStatusCode)
        {
            full_gameInfo.question_List = editQ.Content.ReadFromJsonAsync<List<QuestionDB>>().Result;
            toShow = new QuestionDB();
            toShow.QuestionText = "";
            toShow.GameID = GameCode;
        }
    }

    private void AddInput()
    {
        toShow = new QuestionDB();
        toShow.QuestionText = "";
        toShow.GameID = GameCode;
        toShow.Answers = new List<AnswerDB>();
        isShown = "true";
        //questionList.Add(toShow);
    }

    private void AddAns()
    {
        toShow.Answers.Add(new AnswerDB());
    }
    private void RemoveInput(QuestionDB input)
    {
        isShown = "false";
        full_gameInfo.question_List.Remove(input);
    }

    void ShowQuestion(QuestionDB questionToShow)
    {
        isShown = "Edit";
        toShow = questionToShow;
    }


    void ShowError(string error)
    {
        switch (error)
        {
            case "user is not authenticated":
                msg = "ארעה בעיה בעת אימות המשתמש";
                break;
            case "Game not created":
                msg = "ארעה בעיה בעת יצירת המשחק";
                break;
            case "Game code not created":
                msg = "ארעה בעיה בעת יצירת קוד המשחק";
                break;
            case "Updated":
                msg = "המשחק עודכן בהצלחה";
                break;
            case "Update failed":
                msg = "העדכון נכשל";
                break;
        }
    }
}
